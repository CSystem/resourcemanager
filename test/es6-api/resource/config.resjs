var fs = require("fs");
var path = require("path");


exports.groups = { "preload": ["bg_jpg"] };
exports.alias = { "bg_jpg": "assets/bg.jpg" };
exports.filter = function(p, plugins) {

    var cwebp = require(path.resolve(__dirname, '../../../node_modules/cwebp-bin'));
    var execFile = require('child_process').execFile;

    return new Promise((reslove, reject) => {
        var ext = p.substr(p.lastIndexOf(".") + 1);
        var type;
        switch (ext) {
            case "json":
                if (p.indexOf("sheet") >= 0) {
                    type = "sheet";
                } else if (p.indexOf("movieclip") >= 0) {
                    type = "movieclip";
                } else {
                    type = "json";
                }
                break;
            case "png":
            case "jpg":
                type = "image";
                break;
            case "fnt":
                type = "font";
                break;
            case "mp3":
                type = "sound";
                break;
			case "pvr":
				type = "pvr";
				break;
        }
        if (type) {

            if (ext == "jpg" || ext == "png") {
                var source = path.join(__dirname, p);
                var output = source.replace(ext, "webp");
                execFile(cwebp, [source, '-o', output], function(err) {
                    if (err) {
                        throw err;
                    }
                    var url = path.relative(__dirname,output);//plugins.crc32(p) + "." + ext;
                    reslove({ url, type })
                })
            }
            else {
                var url = p;//plugins.crc32(p) + "." + ext;
                reslove({ url, type });
            }
        }
        else {
			reslove(null);
        }
    });


}
exports.resources = {
	"assets": {
		"armature": {
			"skeleton.json": {
				"url": "assets/armature/skeleton.json",
				"type": "json"
			},
			"texture.json": {
				"url": "assets/armature/texture.json",
				"type": "json"
			},
			"texture.png": {
				"url": "assets/armature/texture.webp",
				"type": "image"
			}
		},
		"font": {
			"font.fnt": {
				"url": "assets/font/font.fnt",
				"type": "font"
			},
			"font.png": {
				"url": "assets/font/font.webp",
				"type": "image"
			}
		},
		"movieclip": {
			"movieclip.json": {
				"url": "assets/movieclip/movieclip.json",
				"type": "movieclip"
			},
			"movieclip.png": {
				"url": "assets/movieclip/movieclip.webp",
				"type": "image"
			}
		},
		"pvr": {
			"0.pvr": {
				"url": "assets/pvr/0.pvr",
				"type": "pvr"
			}
		},
		"sheet": {
			"sheet1.json": {
				"url": "assets/sheet/sheet1.json",
				"type": "sheet"
			},
			"sheet1.png": {
				"url": "assets/sheet/sheet1.webp",
				"type": "image"
			}
		},
		"sound": {
			"sound_go.mp3": {
				"url": "assets/sound/sound_go.mp3",
				"type": "sound"
			}
		},
		"egret_icon.png": {
			"url": "assets/egret_icon.webp",
			"type": "image"
		},
		"bg.jpg": {
			"url": "assets/bg.webp",
			"type": "image"
		}
	}
}

