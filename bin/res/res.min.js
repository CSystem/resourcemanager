var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},RES;!function(e){e.checkNull=function(e,t,r){var o=r.value;r.value=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];return e[0]?o.apply(this,e):(console.warn("方法"+t+"的参数不能为null"),null)}},e.checkDecorator=function(t,r,o){var n=o.value;o.value=function(t,r){return r&&console.warn("已经废弃 resourceRoot"),t&&console.warn("已经废弃 url"),console.assert(e.configItem,"需要为文档类添加 RES.mapConfig 注解"),n.apply(this)}}}(RES||(RES={}));var RES;!function(e){var t;!function(t){function r(t){var r,o=e.configInstance;if(o.config)for(var n in o.config.alias)o.config.alias[n]==t.url&&(r=n);else r=t.url;var i={name:r,url:t.url,type:t.type,data:t,groupName:"",loaded:!0};return i}t.TYPE_IMAGE="image",t.convertToResItem=r}(t=e.ResourceItem||(e.ResourceItem={}))}(RES||(RES={}));var RES;!function(e){var t=function(){function t(){e.configInstance=this}return t.prototype.getGroupByName=function(e,t){var r=this.config.groups[e],o=[];if(!r){if(t)throw"none group "+e;return null}for(var n=0,i=r;n<i.length;n++){var s=i[n],a=this.getResource(s,!0);o.push(a)}return o},t.prototype.__temp__get__type__via__url=function(e){var t=this.config.alias[e];t||(t=e);var r=t.substr(t.lastIndexOf(".")+1);r&&(r=r.toLowerCase());var o;switch(r){case"xml":case"json":case"sheet":o=r;break;case"png":case"jpg":case"gif":case"jpeg":case"bmp":o="image";break;case"fnt":o="font";break;case"txt":o="text";break;case"mp3":case"ogg":case"mpeg":case"wav":case"m4a":case"mp4":case"aiff":case"wma":case"mid":o="sound";break;case"jmc":o="json";break;default:o="bin"}return o},t.prototype.getKeyByAlias=function(e){return this.config.alias[e]?this.config.alias[e]:e},t.prototype.getResource=function(e,t){var r=this.config.alias[e];r||(r=e);var o=this.config.resources[r];if(!o){if(t)throw"none resource url or alias : "+e;return null}return o},t.prototype.getGroup=function(e){return this.getGroupByName(e)},t.prototype.createGroup=function(e,t,r){if(void 0===r&&(r=!1),!r&&this.config.groups[e]||!t||0==t.length)return!1;for(var o=[],n=0,i=t;n<i.length;n++){var s=i[n];if(this.config.groups[s]){var a=this.config.groups[s];o=o.concat(a)}else this.config.alias[s]||this.config.resources[s]?o=o.concat(s):(o=o.concat(s),console.warn("resource not exist : "+s))}return this.config.groups[e]=o,!0},t.prototype.parseConfig=function(e,t){var r=e.resources;for(var o in r){var n=r[o];n.url=t+"/"+n.url,n.name=o}this.config=e},t.prototype.addSubkey=function(e,t){this.addAlias(e,t)},t.prototype.addAlias=function(e,t){this.config.alias[t]&&(t=this.config.alias[t]),this.config.alias[e]=t+"#"+e},t.prototype.getType=function(e){return this.getResource(e,!0).type},t.prototype.addResourceData=function(e){e.type||(e.type=this.__temp__get__type__via__url(e.url)),this.config.resources[e.url]=e,e.name&&(this.config.alias[e.name]=e.url)},t}();e.ResourceConfig=t}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(){t.call(this),this.thread=2,this.loadingCount=0,this.groupTotalDic={},this.numLoadedDic={},this.itemListDic={},this.groupErrorDic={},this.retryTimesDic={},this.maxRetryTimes=3,this.failedList=new Array,this.priorityQueue={},this.lazyLoadList=new Array,this.analyzerDic={},this.queueIndex=0}return __extends(r,t),r.prototype.isGroupInLoading=function(e){return void 0!==this.itemListDic[e]},r.prototype.loadGroup=function(t,r,o){if(void 0===o&&(o=0),!this.itemListDic[r]&&r){if(!t||0==t.length){egret.$warn(3201,r);var n=new e.ResourceEvent(e.ResourceEvent.GROUP_LOAD_ERROR);return n.groupName=r,void this.dispatchEvent(n)}this.priorityQueue[o]?this.priorityQueue[o].push(r):this.priorityQueue[o]=[r],this.itemListDic[r]=t;for(var i=t.length,s=0;s<i;s++){var a=t[s];a.groupName=r}this.groupTotalDic[r]=t.length,this.numLoadedDic[r]=0,this.next()}},r.prototype.loadItem=function(e){this.lazyLoadList.push(e),e.groupName="",this.next()},r.prototype.next=function(){for(var t=this,r=function(r){e.host.load(r).then(function(o){e.host.save(r,o),r.loaded=!0,t.onItemComplete(r)})};this.loadingCount<this.thread;){var o=this.getOneResourceItem();if(!o)break;this.loadingCount++,o.loaded?this.onItemComplete(o):r(o)}},r.prototype.getOneResourceItem=function(){if(this.failedList.length>0)return this.failedList.shift();var e=Number.NEGATIVE_INFINITY;for(var t in this.priorityQueue)e=Math.max(e,t);var r=this.priorityQueue[e];if(!r||0==r.length){if(0==this.lazyLoadList.length)return;return this.lazyLoadList.pop()}for(var o=r.length,n=[],i=0;i<o&&(this.queueIndex>=o&&(this.queueIndex=0),n=this.itemListDic[r[this.queueIndex]],!(n.length>0));i++)this.queueIndex++;return 0!=n.length?n.shift():void 0},r.prototype.onItemComplete=function(t){this.loadingCount--;var r=t.groupName;if(!t.loaded){var o=this.retryTimesDic[t.name]||1;if(!(o>this.maxRetryTimes))return this.retryTimesDic[t.name]=o+1,this.failedList.push(t),void this.next();delete this.retryTimesDic[t.name],e.ResourceEvent.dispatchResourceEvent(this.resInstance,e.ResourceEvent.ITEM_LOAD_ERROR,r,t)}if(r){this.numLoadedDic[r]++;var n=this.numLoadedDic[r],i=this.groupTotalDic[r];if(t.loaded||(this.groupErrorDic[r]=!0),e.ResourceEvent.dispatchResourceEvent(this.resInstance,e.ResourceEvent.GROUP_PROGRESS,r,t,n,i),n==i){var s=this.groupErrorDic[r];this.removeGroupName(r),delete this.groupTotalDic[r],delete this.numLoadedDic[r],delete this.itemListDic[r],delete this.groupErrorDic[r],s?e.ResourceEvent.dispatchResourceEvent(this,e.ResourceEvent.GROUP_LOAD_ERROR,r):e.ResourceEvent.dispatchResourceEvent(this,e.ResourceEvent.GROUP_COMPLETE,r)}}else this.callBack.call(this.resInstance,t);this.next()},r.prototype.removeGroupName=function(e){for(var t in this.priorityQueue){for(var r=this.priorityQueue[t],o=r.length,n=0,i=!1,o=r.length,s=0;s<o;s++){var a=r[s];if(a==e){r.splice(n,1),i=!0;break}n++}if(i){0==r.length&&delete this.priorityQueue[t];break}}},r}(egret.EventDispatcher);e.ResourceLoader=t}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(e,r,o){void 0===r&&(r=!1),void 0===o&&(o=!1),t.call(this,e,r,o),this.itemsLoaded=0,this.itemsTotal=0,this.groupName=""}return __extends(r,t),r.dispatchResourceEvent=function(t,o,n,i,s,a){void 0===n&&(n=""),void 0===i&&(i=void 0),void 0===s&&(s=0),void 0===a&&(a=0);var u=egret.Event.create(r,o);u.groupName=n,i&&(u.resItem=e.ResourceItem.convertToResItem(i)),u.itemsLoaded=s,u.itemsTotal=a;var c=t.dispatchEvent(u);return egret.Event.release(u),c},r}(egret.Event);t.ITEM_LOAD_ERROR="itemLoadError",t.CONFIG_COMPLETE="configComplete",t.CONFIG_LOAD_ERROR="configLoadError",t.GROUP_PROGRESS="groupProgress",t.GROUP_COMPLETE="groupComplete",t.GROUP_LOAD_ERROR="groupLoadError",e.ResourceEvent=t}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(){t.call(this),this.resourceConfig=e.configInstance}return __extends(r,t),r.prototype.addSubkey=function(e,t){this.resourceConfig.addSubkey(e,t)},r.prototype.loadFile=function(e,t,r){},r.prototype.getRes=function(e,t){},r.prototype.destroyRes=function(e){return!1},r.getStringPrefix=function(e){if(!e)return"";var t=e.indexOf(".");return t!=-1?e.substring(0,t):""},r}(egret.HashObject);e.AnalyzerBase=t}(RES||(RES={}));var __awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))(function(n,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(s,a)}u((o=o.apply(e,t)).next())})},__generator=this&&this.__generator||function(e,t){function r(r){if(n)throw new TypeError("Generator is already executing.");for(;;){if(i.done)switch(r[0]){case 0:return{value:void 0,done:!0};case 1:case 6:throw r[1];case 2:return{value:r[1],done:!0}}try{switch(n=1,r[0]){case 0:case 1:o=r;break;case 4:return i.label++,{value:r[1],done:!1};case 7:r=i.stack.pop(),i.trys.pop();continue;default:var s=i.trys.length>0&&i.trys[i.trys.length-1];if(!s&&(6===r[0]||2===r[0])){i.done=1;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){i.label=r[1];break}if(6===r[0]&&i.label<s[1]){i.label=s[1],o=r;break}if(s&&i.label<s[2]){i.label=s[2],i.stack.push(r);break}s[2]&&i.stack.pop(),i.trys.pop();continue}r=t.call(e,i)}catch(e){r=[6,e]}finally{n=0,o=void 0}}}var o,n,i={label:0,sent:function(){if(1===o[0])throw o[1];return o[1]},trys:[],stack:[]};return{next:function(e){return r([0,e])},throw:function(e){return r([1,e])},return:function(e){return r([2,e])}}},RES;!function(e){function t(e){return __awaiter(this,void 0,void 0,function(){return t=this,__generator(this,function(r){return[2,new Promise(function(r,o){var n=function(){var t=e.data?e.data:e.response;r(t)},i=function(){o()};e.addEventListener(egret.Event.COMPLETE,n,t),e.addEventListener(egret.IOErrorEvent.IO_ERROR,i,t)})]})});var t}function r(e,t){e=e.split("\\").join("/");var r=e.match(/#.*|\?.*/),o="";r&&(o=r[0]);var n=e.lastIndexOf("/");return e=n!=-1?e.substring(0,n+1)+t:t,e+o}e.getRelativePath=r,e.ImageProcessor={onLoadStart:function(e,r){return __awaiter(this,void 0,void 0,function(){var e,o,n;return __generator(this,function(i){switch(i.label){case 0:return e=new egret.ImageLoader,e.load(r.url),[4,t(e)];case 1:return o=i.sent(),n=new egret.Texture,n._setBitmapData(o),[2,n]}})})},onRemoveStart:function(e,t){var r=e.get(t);return r.dispose(),Promise.resolve()}},e.TextProcessor={onLoadStart:function(e,r){return __awaiter(this,void 0,void 0,function(){var e,o;return __generator(this,function(n){switch(n.label){case 0:return e=new egret.HttpRequest,e.responseType=egret.HttpResponseType.TEXT,e.open(r.url,"get"),e.send(),[4,t(e)];case 1:return o=n.sent(),[2,o]}})})},onRemoveStart:function(e,t){return Promise.resolve()}},e.JsonProcessor={onLoadStart:function(t,r){return __awaiter(this,void 0,void 0,function(){var o,n;return __generator(this,function(i){switch(i.label){case 0:return[4,t.load(r,e.TextProcessor)];case 1:return o=i.sent(),n=JSON.parse(o),[2,n]}})})},onRemoveStart:function(e,t){return Promise.resolve()}},e.XMLProcessor={onLoadStart:function(t,r){return __awaiter(this,void 0,void 0,function(){var o,n;return __generator(this,function(i){switch(i.label){case 0:return[4,t.load(r,e.TextProcessor)];case 1:return o=i.sent(),n=egret.XML.parse(o),[2,n]}})})},onRemoveStart:function(e,t){return Promise.resolve()}},e.SheetProcessor={onLoadStart:function(t,o){return __awaiter(this,void 0,void 0,function(){var n,i,s,a,u,c,f,l,a;return __generator(this,function(h){switch(h.label){case 0:return[4,t.load(o,e.JsonProcessor)];case 1:if(n=h.sent(),console.log(11),console.log(n),i=r(o.url,n.file),t.resourceConfig.addResourceData({name:i,type:"image",url:i}),s=t.resourceConfig.getResource(i),!s)throw"error";return[4,t.load(s)];case 2:if(a=h.sent(),u=n.frames,!u)throw"error";c=new egret.SpriteSheet(a);for(f in u)l=u[f],a=c.createTexture(f,l.x,l.y,l.w,l.h,l.offX,l.offY,l.sourceW,l.sourceH);return console.log(c),[2,c]}})})},onRemoveStart:function(e,t){return Promise.resolve()}}}(RES||(RES={}));var __decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},RES;!function(e){function t(e,t){G.registerAnalyzer(e,t)}function r(e,t){G.loadConfig()}function o(e,t){void 0===t&&(t=0),G.loadGroup(e,t)}function n(e){return G.isGroupLoaded(e)}function i(t){return G.getGroupByName(t).map(function(t){return e.ResourceItem.convertToResItem(t)})}function s(e,t,r){return void 0===r&&(r=!1),G.createGroup(e,t,r)}function a(e){return G.hasRes(e)}function u(e,t){void 0===t&&(t=""),G.parseConfig(e,t)}function c(e){return G.getRes(e)}function f(e,t,r){G.getResAsync(e,t,r)}function l(e,t,r,o){void 0===o&&(o=""),G.getResByUrl(e,t,r,o)}function h(e,t){return G.destroyRes(e,t)}function p(e){G.setMaxLoadingThread(e)}function d(e){G.setMaxRetryTimes(e)}function g(e,t,r,o,n){void 0===o&&(o=!1),void 0===n&&(n=0),G.addEventListener(e,t,r,o,n)}function v(e,t,r,o){void 0===o&&(o=!1),G.removeEventListener(e,t,r,o)}function R(e){return e.url}function y(e){return G.getVirtualUrl(e)}function m(e){G.addResourceData(e)}function E(t,r){return function(o){var n,i="json";n="string"==typeof r?r:r(),0!=n.lastIndexOf("/")&&(n+="/"),e.configItem={url:t,resourceRoot:n,type:i,name:t}}}var _={};e.host={get resourceConfig(){return e.configInstance},load:function(t,r){if(r||(r=e.host.isSupport(t)),!r)throw"error";return r.onLoadStart(e.host,t)},unload:function(t){var r=e.host.isSupport(t);return r?r.onRemoveStart(e.host,t):Promise.resolve()},save:function(e,t){_[e.url]=t},get:function(e){return _[e.url]},remove:function(e){delete _[e.url]},isSupport:function(t){var r=t.type,o={image:e.ImageProcessor,json:e.JsonProcessor,text:e.TextProcessor,xml:e.XMLProcessor,sheet:e.SheetProcessor};return o[r]}},e.registerAnalyzer=t,e.loadConfig=r,e.loadGroup=o,e.isGroupLoaded=n,e.getGroupByName=i,e.createGroup=s,e.hasRes=a,e.parseConfig=u,e.getRes=c,e.getResAsync=f,e.getResByUrl=l,e.destroyRes=h,e.setMaxLoadingThread=p,e.setMaxRetryTimes=d,e.addEventListener=g,e.removeEventListener=v,e.$getVirtualUrl=R,e.getVirtualUrl=y,e.$addResourceData=m;var L=function(t){function r(){t.call(this),this.analyzerDic={},this.callLaterFlag=!1,this.configComplete=!1,this.loadedGroups=[],this.groupNameList=[],this.init()}return __extends(r,t),r.prototype.$getAnalyzerByType=function(e){var t=this.analyzerDic[e];return t},r.prototype.parseResKey=function(e){e=this.resConfig.getKeyByAlias(e);var t=e.indexOf("#");return t>=0?{key:e.substr(0,t),subkey:e.substr(t+1)}:{key:e,subkey:""}},r.prototype.registerAnalyzer=function(e,t){throw"unimplement"},r.prototype.init=function(){this.resConfig=new e.ResourceConfig,this.resLoader=new e.ResourceLoader,this.resLoader.resInstance=this,this.resLoader.addEventListener(e.ResourceEvent.GROUP_COMPLETE,this.onGroupComp,this),this.resLoader.addEventListener(e.ResourceEvent.GROUP_LOAD_ERROR,this.onGroupError,this)},r.prototype.loadConfig=function(){this.callLaterFlag||(egret.callLater(this.startLoadConfig,this),this.callLaterFlag=!0)},r.prototype.startLoadConfig=function(){this.callLaterFlag=!1;var t=e.configItem;this.resLoader.loadGroup([t],r.GROUP_CONFIG,Number.MAX_VALUE)},r.prototype.isGroupLoaded=function(e){return this.loadedGroups.indexOf(e)!=-1},r.prototype.getGroupByName=function(e){return this.resConfig.getGroupByName(e)},r.prototype.loadGroup=function(t,r){if(void 0===r&&(r=0),this.loadedGroups.indexOf(t)!=-1)return void e.ResourceEvent.dispatchResourceEvent(this,e.ResourceEvent.GROUP_COMPLETE,t);if(!this.resLoader.isGroupInLoading(t))if(this.configComplete){var o=this.resConfig.getGroupByName(t);this.resLoader.loadGroup(o,t,r)}else this.groupNameList.push({name:t,priority:r})},r.prototype.createGroup=function(e,t,r){if(void 0===r&&(r=!1),r){var o=this.loadedGroups.indexOf(e);o!=-1&&this.loadedGroups.splice(o,1)}return this.resConfig.createGroup(e,t,r)},r.prototype.onGroupComp=function(t){if(t.groupName==r.GROUP_CONFIG){var o=e.host.get(e.configItem);this.resConfig.parseConfig(o,"resource"),this.configComplete=!0,e.ResourceEvent.dispatchResourceEvent(this,e.ResourceEvent.CONFIG_COMPLETE),this.loadDelayGroups()}else this.loadedGroups.push(t.groupName),this.dispatchEvent(t)},r.prototype.loadDelayGroups=function(){var e=this.groupNameList;this.groupNameList=[];for(var t=e.length,r=0;r<t;r++){var o=e[r];this.loadGroup(o.name,o.priority)}},r.prototype.onGroupError=function(t){t.groupName==r.GROUP_CONFIG?e.ResourceEvent.dispatchResourceEvent(this,e.ResourceEvent.CONFIG_LOAD_ERROR):this.dispatchEvent(t)},r.prototype.hasRes=function(e){var t=this.parseResKey(e).key;return null!=this.resConfig.getResource(t)},r.prototype.parseConfig=function(e,t){console.warn("已经废弃的方法"),this.resConfig.parseConfig(e,t)},r.prototype.getRes=function(t){var r=this.parseResKey(t),o=r.key,n=(r.subkey,this.resConfig.getResource(o));if(n&&e.host.isSupport(n))return e.host.get(n)},r.prototype.getResAsync=function(t,r,o){var n=this.parseResKey(t),t=n.key,i=(n.subkey,this.resConfig.getResource(t,!0)),s=(i.url,e.host.get(i));return s?void egret.$callAsync(r,o,s,t):void e.host.load(i).then(function(e){r.call(o,e,i.url)})},r.prototype.getResByUrl=function(e,t,r,o){void 0===o&&(o="");var n=this.resConfig.getResource(e);n||this.resConfig.addResourceData({name:e,url:e}),this.getResAsync(e,t,r)},r.prototype.destroyRes=function(t,r){void 0===r&&(r=!0);var o=this.resConfig.getGroup(t),n=function(t){e.host.unload(t).then(function(){return e.host.remove(t)})};if(o&&o.length>0){var i=this.loadedGroups.indexOf(t);i!=-1&&this.loadedGroups.splice(i,1);for(var s=0,a=o;s<a.length;s++){var u=a[s];!r&&this.isResInLoadedGroup(u)||(u.loaded=!1,n(u),this.removeLoadedGroupsByItemName(u.url))}return!0}var u=this.resConfig.getResource(t);return u?(u.loaded=!1,e.host.isSupport(u)&&e.host.unload(u),this.removeLoadedGroupsByItemName(u.url),!0):(console.warn("无法删除指定组:"+t),!1)},r.prototype.removeLoadedGroupsByItemName=function(e){for(var t=this.loadedGroups,r=t.length,o=0;o<r;o++)for(var n=this.resConfig.getGroupByName(t[o],!0),i=n.length,s=0;s<i;s++){var a=n[s];if(a.name==e){t.splice(o,1),o--,r=t.length;break}}},r.prototype.isResInLoadedGroup=function(e){for(var t=this.loadedGroups,r=t.length,o=0;o<r;o++)for(var n=this.resConfig.getGroupByName(t[o],!0),i=n.length,s=0;s<i;s++){var a=n[s];if(a.url==e.url)return!0}return!1},r.prototype.setMaxLoadingThread=function(e){e<1&&(e=1),this.resLoader.thread=e},r.prototype.setMaxRetryTimes=function(e){e=Math.max(e,0),this.resLoader.maxRetryTimes=e},r.prototype.addResourceData=function(e){this.resConfig.addResourceData(e)},r.prototype.getVirtualUrl=function(e){var t=this.resConfig.getResource(e);return t?t.url:(console.warn("warn","res","1"),e)},r}(egret.EventDispatcher);L.GROUP_CONFIG="RES__CONFIG",__decorate([e.checkDecorator],L.prototype,"loadConfig",null),__decorate([e.checkNull],L.prototype,"getRes",null),e.Resource=L;var G=new L;e.mapConfig=E}(RES||(RES={}));var egret;!function(e){e.$locale_strings=e.$locale_strings||{},e.$locale_strings.zh_CN=e.$locale_strings.zh_CN||{};var t=e.$locale_strings.zh_CN;t[3200]="RES.createGroup()传入了配置中不存在的键值: {0}",t[3201]='RES加载了不存在或空的资源组:"{0}"',t[3202]="请不要使用不同的类型方式来加载同一个素材！",t[3203]="找不到指定文件类型的解析器:{0}。 请先在项目初始化里注册指定文件类型的解析器，再启动资源加载。"}(egret||(egret={}));